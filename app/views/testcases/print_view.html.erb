<% content_for :header_tags do %>
  <%= stylesheet_link_tag 'testcases', plugin: 'redmine_testcase' %>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .print-header { border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; }
    .print-header h1 { margin: 0; font-size: 24px; }
    .print-info { margin: 10px 0; font-size: 12px; }
    .print-info strong { display: inline-block; min-width: 100px; }
    @media print {
      .contextual { display: none; }
      body { margin: 0; }
    }
  </style>
<% end %>

<div class="print-header">
  <h1><%= l(:label_test_case_report) %></h1>
  <div class="print-info">
    <p><strong><%= l(:field_project) %>:</strong> <%= @project.name %></p>
    <p><strong><%= l(:field_issue) %>:</strong> #<%= @issue.id %> - <%= @issue.subject %></p>
    <p><strong><%= l(:field_tracker) %>:</strong> <%= @issue.tracker.name %></p>
    <p><strong><%= l(:field_status) %>:</strong> <%= @issue.status.name %></p>
    <p><strong><%= l(:field_author) %>:</strong> <%= @issue.author.name %></p>
    <p><strong><%= l(:label_date) %>:</strong> <%= format_date(Date.today) %></p>
  </div>
</div>

<h2><%= l(:label_test_cases_summary) %></h2>

<table class="list summary-table" style="width: 100%; margin-bottom: 30px;">
  <thead>
    <tr>
      <th><%= l(:label_total_test_cases) %></th>
      <% Testcase.status_values.each do |status| %>
        <th><%= l("testcase_status_#{status}") %></th>
      <% end %>
      <th><%= l(:label_percentage_passed) %></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center;"><strong><%= @summary[:total] %></strong></td>
      <% Testcase.status_values.each do |status| %>
        <td style="text-align: center;"><%= @summary[:by_status][status] || 0 %></td>
      <% end %>
      <td style="text-align: center;"><strong><%= @summary[:pass_rate] %>%</strong></td>
    </tr>
  </tbody>
</table>

<h2><%= l(:label_test_cases) %> (<%= @testcases.count %>)</h2>

<% @testcases.each_with_index do |testcase, index| %>
  <div class="testcase-print-item" style="page-break-inside: avoid; margin-bottom: 30px; border: 1px solid #ccc; padding: 15px;">
    <h3 style="margin-top: 0; color: #169;">
      <%= index + 1 %>. <%= testcase.test_case_id %> - <%= testcase.title %>
    </h3>

    <table style="width: 100%; font-size: 12px; margin-bottom: 10px;">
      <tr>
        <td style="width: 20%; vertical-align: top;"><strong><%= l(:label_test_case_status) %>:</strong></td>
        <td><%= testcase_status_badge(testcase) %></td>
      </tr>
    </table>

    <% if testcase.preconditions.present? %>
      <div style="margin: 10px 0;">
        <strong><%= l(:label_test_case_preconditions) %>:</strong>
        <div style="margin-left: 20px; margin-top: 5px;">
          <%= format_testcase_field(testcase.preconditions) %>
        </div>
      </div>
    <% end %>

    <% if testcase.steps.present? %>
      <div style="margin: 10px 0;">
        <strong><%= l(:label_test_case_steps) %>:</strong>
        <div style="margin-left: 20px; margin-top: 5px;">
          <%= format_testcase_field(testcase.steps) %>
        </div>
      </div>
    <% end %>

    <% if testcase.expected_result.present? %>
      <div style="margin: 10px 0;">
        <strong><%= l(:label_test_case_expected) %>:</strong>
        <div style="margin-left: 20px; margin-top: 5px;">
          <%= format_testcase_field(testcase.expected_result) %>
        </div>
      </div>
    <% end %>

    <% if testcase.actual_result.present? %>
      <div style="margin: 10px 0;">
        <strong><%= l(:label_test_case_actual) %>:</strong>
        <div style="margin-left: 20px; margin-top: 5px;">
          <%= format_testcase_field(testcase.actual_result) %>
        </div>
      </div>
    <% end %>

    <% if testcase.comments.present? %>
      <div style="margin: 10px 0;">
        <strong><%= l(:label_test_case_comments) %>:</strong>
        <div style="margin-left: 20px; margin-top: 5px;">
          <%= format_testcase_field(testcase.comments) %>
        </div>
      </div>
    <% end %>

    <% if testcase.attachments.any? %>
      <div style="margin: 10px 0;">
        <strong><%= l(:label_attachment_plural) %>:</strong>
        <div style="margin-left: 20px; margin-top: 5px;">
          <ul style="list-style-type: disc; margin-left: 20px;">
            <% testcase.attachments.each do |attachment| %>
              <li><%= attachment.filename %> (<%= number_to_human_size(attachment.filesize) %>)</li>
            <% end %>
          </ul>
        </div>
      </div>
    <% end %>

    <div style="margin-top: 10px; font-size: 11px; color: #999;">
      <%= l(:label_last_updated) %>: <%= format_time(testcase.updated_at) %>
    </div>
  </div>
<% end %>

<div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ccc; text-align: center; font-size: 11px; color: #999;">
  <p><%= l(:text_generated_by) rescue 'Generated by' %> Redmine TestCase Plugin - <%= format_time(Time.now) %></p>
</div>
